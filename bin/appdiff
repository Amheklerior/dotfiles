#!/usr/bin/env zsh

### appdiff:
### compare the list of currently installed apps with the default list from the brewfile

local TMP=$(mktemp -d)
local BUNDLES_DIR="$DOTFILES_REPO/bundles"
local APPS_BUNDLE="$BUNDLES_DIR/apps.bundle"
local FONTS_BUNDLE="$BUNDLES_DIR/fonts.bundle"
local WORK_BUNDLE="$BUNDLES_DIR/hh.bundle"

local _extract_apps() {
  rg '^(cask|mas)' | sed -e 's/cask \"\(.*\)\"/\1/' -e 's/mas \"\(.*\)\".*/\1/'
}

local _strip_comments() {
  sed -e 's/ #.*//g'
}

# get the default list of cask and mas apps from the brewfile
local DEFAULT=$TMP/apps_default
cat $APPS_BUNDLE $FONTS_BUNDLE $WORK_BUNDLE | _extract_apps | _strip_comments | sort > $DEFAULT

# get the list of currently installed cask and mas apps
local CURRENT=$TMP/apps_current
brew bundle dump --cask --mas --force --file=$TMP/Brewfile.dump
cat $TMP/Brewfile.dump | _extract_apps | sort > $CURRENT

# show differences
# NOTE: The -U0 options makes the outoput more compact by removing context lines
git diff --no-index -U0 $DEFAULT $CURRENT

# cleanup temporary generated files
rm -r $TMP